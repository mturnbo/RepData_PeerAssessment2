---
title: "Storm Event Effects on Population Health and Economics (1950 - 2011)"
author: "Marcus Turnbo"
date: "November 22, 2014"
output: html_document
---

This report gives an overview of analysis of storm data from the U.S. National Oceanic and Atmospheric 
Administration (NOAA).  The data includes characteristics of major storms and weather events in the United States, 
including date and location, as well as estimates of any fatalities, injuries, and property damage.  A simple
analysis has been performed to determine events with the greatest impact in the United States.

### Data Processing 

A CSV file downloaded from the NOAA website is loaded into a dataframe.  A subset of this data with STATE values
only in the state.abb vector is created to ensure we are working with events only in the United States.  The event
year is extracted from the BGN_DATE and used to create a summary table with total, minimum, maximum, and average
values for fatalities, injuries, property damage, and crop damage.  To check for completeness of data, the minimum
year that data exists for these metrics is calculated.

```{r, echo=TRUE, warning=FALSE}
library(data.table)
library(plyr)
library(lubridate)

# read storm data
stormData <- (read.csv('./data/repdata-data-StormData.csv', header=TRUE))
# subset storm data in United States based on STATE value
stormDataUS <- subset(stormData, STATE %in% state.abb)

# create event year column
stormDataUS$EVENT_YEAR <- year(parse_date_time(stormDataUS$BGN_DATE, "%m/%d/%y %H%M%S"))

# create summary table
eventSummary <- data.table(ddply(stormDataUS, c('EVENT_YEAR'), summarise, 
  num.events = length(REFNUM),
  total.fatality = sum(FATALITIES),
  min.fatality = min(FATALITIES),
  max.fatality = max(FATALITIES),
  avg.fatality = mean(FATALITIES),
  total.injury = sum(INJURIES),
  min.injury = min(INJURIES),
  max.injury = max(INJURIES),
  avg.injury = mean(INJURIES),
  total.propertydamage = sum(PROPDMG),
  min.propertydamage = min(PROPDMG),
  max.propertydamage = max(PROPDMG),
  avg.propertydamage = mean(PROPDMG),
  total.cropdamage = sum(PROPDMG),
  min.cropdamage = min(CROPDMG),
  max.cropdamage = max(CROPDMG),
  avg.cropdamage = mean(CROPDMG)
))
setnames(eventSummary, names(eventSummary)[1], c('event.year'))

# find earliest years where data exists
earliestFatalityYear <- min(eventSummary[which(eventSummary$max.fatality > 0), event.year])
earliestInjuryYear <- min(eventSummary[which(eventSummary$max.injury > 0), event.year])
earliestPropertyDamageYear <- min(eventSummary[which(eventSummary$max.propertydamage > 0), event.year])
earliestCropDamageYear <- min(eventSummary[which(eventSummary$max.cropdamage > 0), event.year])
```

`r nrow(stormData)` observations were found in the downloaded data.
- The downloaded data includes events from `r min(eventSummary$EVENT_YEAR)` through `r max(eventSummary$EVENT_YEAR)`. 
- The earliest fatality data is in `r earliestFatalityYear`
- The earliest injury data is in `r earliestInjuryYear`
- The earliest property damage data is in `r earliestPropertyDamageYear`
- The earliest crop damage data is in `r earliestPropertyDamageYear`

### Results

#### The most harmful events across the United States with respect to population health:

The storm data for United States is aggregated based on event type to determine which has the most impact on population health.  Only data with values for fatality or injury are used.

```{r, echo=TRUE}
eventImpactPopulationHealth <- subset(ddply(stormDataUS, c('EVTYPE'), summarise, 
  total.fatality = sum(FATALITIES),
  avg.fatality = mean(FATALITIES),
  total.injury = sum(INJURIES),
  avg.injury = mean(INJURIES)
), total.fatality > 0 | total.injury > 0)
rownames(eventImpactPopulationHealth) <- NULL
setnames(eventImpactPopulationHealth, names(eventImpactPopulationHealth)[1], c('event.type'))

eventMaxImpactPopulationHealth <- eventImpactPopulationHealth[ 
  eventImpactPopulationHealth$total.fatality == max(eventImpactPopulationHealth$total.fatality) |
  eventImpactPopulationHealth$avg.fatality == max(eventImpactPopulationHealth$avg.fatality) |
  eventImpactPopulationHealth$total.injury == max(eventImpactPopulationHealth$total.injury) |
  eventImpactPopulationHealth$avg.injury == max(eventImpactPopulationHealth$avg.injury),]

#### Events across the United States with the greatest economic consequences:

The storm data for United States is aggregated based on event type to determine which has the most impact on property and crops.  Only data with values for property damage or crop damage are used.

```{r, echo=TRUE}
eventImpactDamage <- subset(ddply(stormDataUS, c('EVTYPE'), summarise, 
  total.property = sum(PROPDMG),
  avg.property = mean(PROPDMG),
  total.crop = sum(CROPDMG),
  avg.crop = mean(CROPDMG)
), total.property > 0 | total.crop > 0)
rownames(eventImpactDamage) <- NULL
setnames(eventImpactDamage, names(eventImpactDamage)[1], c('event.type'))

eventMaxImpactDamage <- eventImpactDamage[ 
  eventImpactDamage$total.fatality == max(eventImpactDamage$total.fatality) |
  eventImpactDamage$avg.fatality == max(eventImpactDamage$avg.fatality) |
  eventImpactDamage$total.injury == max(eventImpactDamage$total.injury) |
  eventImpactDamage$avg.injury == max(eventImpactDamage$avg.injury),]
```
